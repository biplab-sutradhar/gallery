---
title: "Animint2 Gallery" 
output:
  html_document:
    theme: bootstrap
    self_contained: true
---

```{r setup, include=FALSE}
library(knitr)
library(data.table) 
library(nc)

options(width=200)
knitr::opts_chunk$set(echo=FALSE, results="asis")

# Debug print function
print_debug <- function(label, value) {
  cat(sprintf("\nDEBUG %s: %s\n", label, value))
}

ahref <- function(href, text){
  print_debug("href", href)
  print_debug("text", text)
  sprintf('<a href="%s">%s</a>', href, text)
}

myread <- function(csv, repo.col){
  if(!file.exists(csv)) {
    return(data.table())
  }
  dt <- fread(csv)
  if(nrow(dt) == 0) {
    return(data.table())
  }
  dt[, c("owner", "repo_only") := tstrsplit(viz_owner_repo, "/")]
  dt[, img.png := sprintf("repos/%s.png", viz_owner_repo)]
  
  # Debug print viz_owner_repo
  dt[, print_debug("viz_owner_repo", viz_owner_repo)]
  
  dt[, viz.link := ahref(
    sprintf("https://%s.github.io/%s/", owner, repo_only),
    ifelse(
      file.exists(img.png),
      sprintf('<img src="%s" alt="%s" style="max-width:300px;"/>', img.png, viz_owner_repo),
      viz_owner_repo)
  )]
  dt[, repo.link := ahref(
    sprintf("https://github.com/%s/tree/gh-pages", viz_owner_repo),
    get(repo.col))]
  return(dt)
}

meta.dt <- myread("meta.csv", "title")
if(nrow(meta.dt) > 0) {
  meta.dt[, source.link := ahref(source, commit.POSIXct)]
}
error.dt <- myread("error.csv", "viz_owner_repo")

if(nrow(meta.dt) > 0) {
  cat("### Visualizations\n\n")
  knitr::kable(meta.dt[order(-commit.POSIXct), .(
    "Visualization" = viz.link, 
    "Repository" = repo.link, 
    "Source" = source.link
  )], format = "html")
}